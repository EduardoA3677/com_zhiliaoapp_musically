precision highp float;uniform vec2 uResolution;varying float vTime;varying vec2 vTexCoord;uniform float uLightness;uniform vec2 uPosition,uScale;uniform vec3 uColor1,uColor2,uColor3,uColor4,uBgColor;uniform float uComplex,uMorph,uSpeed,uTimeOffset;
#define PI 3.14159265359
vec2 p(vec2 s,float f){float m=cos(f);f=sin(f);return vec2(m*s.x-f*s.y,f*s.x+m*s.y);}float p(vec2 f,float s,float u){const vec3 m=vec3(-.866025404,.5,.577350269);f=abs(f);f-=2.*min(dot(m.xy,f),0.)*m.xy;f-=vec2(clamp(f.x,-m.z*s,m.z*s),s);return length(f)*sign(f.y)-u;}float x(vec2 f,float u,float s){f=p(f,PI/6.);return p(f,u,s);}vec3 p(int f,int m){vec3 v=uBgColor;return f==0?mix(mix(mix(mix(v,uColor2,step(float(m),.5)*step(-.5,float(m))),uColor4,step(float(m),1.5)*step(.5,float(m))),uColor3,step(float(m),2.5)*step(1.5,float(m))),uColor2,step(2.5,float(m))):f==1?mix(mix(mix(mix(v,uColor1,step(float(m),.5)*step(-.5,float(m))),uColor3,step(float(m),1.5)*step(.5,float(m))),uColor3,step(float(m),2.5)*step(1.5,float(m))),uBgColor,step(2.5,float(m))):f==2?mix(mix(mix(mix(v,uColor2,step(float(m),.5)*step(-.5,float(m))),uColor4,step(float(m),1.5)*step(.5,float(m))),uColor4,step(float(m),2.5)*step(1.5,float(m))),uColor4,step(2.5,float(m))):mix(mix(mix(mix(v,uColor2,step(float(m),.5)*step(-.5,float(m))),uColor4,step(float(m),1.5)*step(.5,float(m))),uColor4,step(float(m),2.5)*step(1.5,float(m))),uColor2,step(2.5,float(m)));}vec3 p(vec2 m,float f,float v,int s){float u=length(m)*4.,x=atan(m.y,m.x),r=uComplex;r=pow(abs((1.-uMorph/.7)*sin(r*.5*x+.4))*sin(x*r-.2)+abs(.2*sin(r*.5*x+.5))*cos(x*r*2.-.5),2.);x=fract((atan(m.y,m.x)+f*44.+v+PI)/(2.*PI));vec3 y;x*=4.;int a=int(x);vec3 i=p(s,0),c=p(s,1),d=p(s,2),P=p(s,3);x=smoothstep(0.,1.,fract(x));y=mix(uBgColor,mix(uBgColor,mix(mix(mix(mix(vec3(0),mix(i,c,x),step(float(a),.5)*step(-.5,float(a))),mix(c,d,x),step(float(a),1.5)*step(.5,float(a))),mix(d,P,x),step(float(a),2.5)*step(1.5,float(a))),mix(P,i,x),step(2.5,float(a))),clamp((1.-smoothstep(r,r+1.,u)+(1.-smoothstep(r,r+3.5,u))*.1)*smoothstep(-.1,1.1,u),0.,1.)),u*2.);return vec3(y);}void main(){vec2 m=(vTexCoord-.5)*2.;m.x*=uResolution.x/uResolution.y;m=vec2(m.x/uScale.x-uPosition.x,m.y/uScale.y+uPosition.y);float f=vTime*.5*uSpeed+uTimeOffset;vec3 v=uBgColor;vec2 s=m*.15;float u=mod(f,1.),r=mix(.1,1.3,u);u=1.-smoothstep(-.01,.01,x(m,r,mix(.1,.6,u)));vec3 i=p(s,.5*mod(f,1e2),0.,0);v=mix(v,i,u*(1.-smoothstep(.2,1.,r)));u=mod(f+.25,1.);r=mix(.1,1.3,u);u=1.-smoothstep(-.01,.01,x(m,r,mix(.1,.6,u)));i=p(s,-mod(f,1e2),2.1,1);v=mix(v,i,u*(1.-smoothstep(.2,1.,r)));u=mod(f+.5,1.);r=mix(.1,1.3,u);u=1.-smoothstep(-.01,.01,x(m,r,mix(.1,.6,u)));i=p(s,mod(f,1e2),2.2,2);v=mix(v,i,u*(1.-smoothstep(.2,1.,r)));u=mod(f+.75,1.);r=mix(.1,1.3,u);u=1.-smoothstep(-.01,.01,x(m,r,mix(.1,.6,u)));i=p(s,mod(f,1e2),9.3,3);v=mix(v,i,u*(1.-smoothstep(.2,1.,r)));v=uLightness>=0.?mix(v,vec3(1),uLightness):mix(v,vec3(0),-uLightness);gl_FragColor=vec4(v,1);}